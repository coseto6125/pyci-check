name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ==================== Code Quality ====================
  code-quality:
    name: Code Quality (Linting & Formatting)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
          pip install -e .

      - name: Run Ruff linter
        run: |
          echo "::group::Ruff Linting"
          ruff check . --config pyproject.toml --output-format=github
          echo "::endgroup::"

      - name: Run Ruff formatter check
        run: |
          echo "::group::Ruff Formatting"
          ruff format --check . --config pyproject.toml
          echo "::endgroup::"

  # ==================== Self Check ====================
  self-check:
    name: Self Check (pyci-check on itself)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install pyci-check
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pyci-check syntax check
        run: |
          echo "::group::Syntax Check"
          pyci-check syntax
          echo "::endgroup::"

      - name: Run pyci-check imports check (static)
        run: |
          echo "::group::Import Check (Static)"
          pyci-check imports
          echo "::endgroup::"

      - name: Run pyci-check imports check (dynamic)
        run: |
          echo "::group::Import Check (Dynamic)"
          pyci-check imports --i-understand-this-will-execute-code
          echo "::endgroup::"

      - name: Run pyci-check full check
        run: |
          echo "::group::Full Check"
          pyci-check check .
          echo "::endgroup::"

  # ==================== Cross-Platform Tests ====================
  test-cross-platform:
    name: Test on ${{ matrix.os }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -e .

      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=src/pyci_check --cov-report=term-missing --cov-report=xml

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ==================== Categorized Tests ====================
  test-syntax:
    name: Test Syntax Checker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e .

      - name: Run syntax tests
        run: |
          echo "::group::Syntax Checker Tests"
          pytest tests/test_syntax.py tests/test_syntax_advanced.py -v
          echo "::endgroup::"

  test-imports:
    name: Test Import Checker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e .

      - name: Run import tests
        run: |
          echo "::group::Import Checker Tests"
          pytest tests/test_imports.py tests/test_imports_advanced.py -v
          echo "::endgroup::"

  test-git-hooks:
    name: Test Git Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e .

      - name: Initialize Git repository
        run: |
          git config --global user.email "ci@example.com"
          git config --global user.name "CI Bot"
          git init

      - name: Run git hooks tests
        run: |
          echo "::group::Git Hooks Tests"
          pytest tests/test_git_hooks.py -v
          echo "::endgroup::"

  test-cli:
    name: Test CLI Interface
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e .

      - name: Run CLI tests
        run: |
          echo "::group::CLI Tests"
          pytest tests/test_cli.py -v
          echo "::endgroup::"

  test-i18n:
    name: Test Internationalization
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e .

      - name: Run i18n tests
        run: |
          echo "::group::I18n Tests"
          pytest tests/test_i18n.py -v
          echo "::endgroup::"

  test-utils:
    name: Test Utilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e .

      - name: Run utils tests
        run: |
          echo "::group::Utils Tests"
          pytest tests/test_utils.py -v
          echo "::endgroup::"

  test-integration:
    name: Test Integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install -e .

      - name: Run integration tests
        run: |
          echo "::group::Integration Tests"
          pytest tests/test_integration.py -v
          echo "::endgroup::"

  # ==================== Type Checking ====================
  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy
          pip install -e .

      - name: Run mypy
        run: |
          echo "::group::Type Check"
          mypy src/pyci_check --ignore-missing-imports --no-strict-optional || true
          echo "::endgroup::"

  # ==================== Package Build ====================
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [code-quality, self-check, test-cross-platform]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          echo "::group::Build Package"
          python -m build
          echo "::endgroup::"

      - name: Check package with twine
        run: |
          echo "::group::Twine Check"
          twine check dist/*
          echo "::endgroup::"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/

  # ==================== Package Installation Tests ====================
  test-install:
    name: Test Package Installation on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages
          path: dist/

      - name: Install from wheel
        shell: bash
        run: |
          echo "::group::Install Package"
          pip install dist/*.whl
          echo "::endgroup::"

      - name: Test CLI is available
        run: |
          echo "::group::Test CLI"
          pyci-check --help
          echo "::endgroup::"

      - name: Verify installation
        run: |
          echo "::group::Verify Installation"
          python -c "import pyci_check; print(f'pyci-check version: {pyci_check.__version__}')"
          echo "::endgroup::"
